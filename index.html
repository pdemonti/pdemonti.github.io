<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="leaflet.css" />
    <link rel="stylesheet" href="L.Control.MousePosition.css" /> 
</head>
<body>
<div id="map" style="width: 500px; height: 450px"></div>
 <form name="form" method="get" action="">
      <input type="hidden" name="easting" id="easting" value="">
     <input type="hidden"  name="northing" id="northing" value="">
     <input type="hidden"  name="wkt" id="wkt" value="">
</form>
<script src="leaflet-src.js"></script>
<script src="proj4.js"></script>
<script src="proj4leaflet.js"></script>
<script src="L.Control.MousePosition.js"></script>
<script src="kml.js"></script>
<script src="leaflet-providers.js"></script>
<script src="terraformer.min.js"></script>
<script src="terraformer-wkt-parser.min.js"></script>
<script>
var easting;
var northing;
var iconDrag = true;
var marker; 
var thepoint;
var thelayer;
///////////////////////////// 
proj4.defs([
  [
    'EPSG:4326',
    '+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees'],
  [
    'EPSG:26911',
    '+proj=utm +zone=11 +ellps=GRS80 +datum=NAD83 +units=m +no_defs'],
  [
    'EPSG:3978',
    '+proj=lcc +lat_1=69 +lat_2=77 +lat_0=49 +lon_0=-119 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs']
	]);
///////////////////////	
	if (form.easting.value == "") {
		x = -117.4;
		y = 51.242;
		//easting =442072;
		//northing = 5667796;
	}else{
		//There are values in the boxes lets convert to DD and add this to the map and zoom to.
		var latlong = proj4('EPSG:26911', 'EPSG:4326', [form.easting.value,form.northing.value]);
		x = latlong[0];
		y = latlong[1]; 
	};
/////////////////define map layers
	// Toporama WMS
	var Toporama = L.tileLayer.wms("http://wms.ess-ws.nrcan.gc.ca/wms/toporama_en", {
		layers: 'WMS-toporama',
		format: 'image/png',
		transparent: false,
		noWrap: true,
		attribution: "Toporama"
	});
// define a maplayer

var Esri_WorldTopoMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri '
});
var NatGeoTopo = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri ',
	maxZoom: 16
});
// https: also suppported.
var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri '
});


//// define KML layer
var track = new L.KML("MRG-bndy-dd.kml", {async: true});
var trails = new L.KML("hike.kml", {async: true});
var cprmm = new L.KML("CPRmm.kml", {async: true});
var tchwpts = new L.KML("TCHwpts.kml", {async: true});
//define marker
/////////////////////////

var marker = new L.Marker([easting,northing],{draggable: iconDrag});
marker.on('dragend', function(event){
				marker = event.target;
				var position = marker.getLatLng(); 
				map.panTo(new L.LatLng(position.lat, position.lng));
				var utm = proj4('EPSG:4326', 'EPSG:26911', [position.lng,position.lat]);
				form.easting.value = Math.round (utm[0] * 10) / 10;
				form.northing.value  = Math.round (utm[1] * 10) / 10;
				});		
				
function zoomTo() {	
};

function SetJavascriptVars(){
		/// get the new coords from the boxes
		wkt = form.wkt.value;
		easting = form.easting.value;
		northing = form.northing.value;
		///if wkt exists use it, else use lat long else use UTMs
		if (wkt.length > 0){
			//if there are markers clear them
			marker.clearLayers();
			thelayer.clearLayers();
			//alert(wkt);
			var geojson = Terraformer.WKT.parse(wkt);
            // Create a geojson layer with our new geojson object
            var thelayer = L.geoJson(geojson, {}).addTo(map);
            // get a geojson bounding box xmin, ymin, xmax, ymax
            var bounds = geojson.bbox();
            // fit the map tp the bounds of the fire.
            map.fitBounds([ [bounds[1], bounds[0]], [bounds[3], bounds[2]] ]);	
		}else{
			var latlong = proj4('EPSG:26911', 'EPSG:4326', [easting,northing]);
			x = latlong[0];
			y = latlong[1];
			thepoint = new L.LatLng(y, x);
			//the point already exists so lets move it.
			marker.setLatLng(thepoint);
			marker.addTo(map);
			marker.update()
			map.panTo(new L.LatLng(y, x));	
		};	
 };
// initialize the map
/////////////////////////////////
	////var map = L.map('map').setView([y,x], 9);
	var map = L.map('map', {
		center: [y,x],
		zoom: 8,
		layers: [Esri_WorldTopoMap, trails]
	});
/////////////////

function onMapClick(e) {
			marker.setLatLng(e.latlng,{draggable: iconDrag});
			marker.addTo(map);
			marker.update()
			//////////////////
			//end on drag end update	
 			var position = marker.getLatLng(); 
			var utm = proj4('EPSG:4326', 'EPSG:26911', [position.lng,position.lat]);
			form.easting.value = Math.round (utm[0] * 10) / 10;
			form.northing.value  = Math.round (utm[1] * 10) / 10; 
			map.panTo(position);	

};

function updateMarkerUtm(){
	position = marker.getLatLng();
	var utm = proj4('EPSG:4326', 'EPSG:26911', [position.lng,position.lat]);
	form.easting.value = Math.round (utm[0] * 10) / 10;
	form.northing.value  = Math.round (utm[1] * 10) / 10;
};
// end on mapClick
map.on('click', onMapClick);
L.control.mousePosition().addTo(map);
//track.on("loaded", function(e) { map.fitBounds(e.target.getBounds()); });
//map.addLayer(track);

var baseMaps = {
    "Toporama": Toporama,
	"NatGeoTopo": NatGeoTopo,
	"Satellite": Esri_WorldImagery,
	"Esri_Topo": Esri_WorldTopoMap
};
var overlayMaps = {"Park Boundary": track, "CPR Mile Markers": cprmm, "TCH Waypoints": tchwpts, "Hiking Trails": trails};
L.control.layers(baseMaps,overlayMaps).addTo(map);

</script>  
</body>
</html>
